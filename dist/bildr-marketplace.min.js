/* Copyright 2022, Jeroen van Menen. bildr-tools 0.4.3 (Fri, 24 Jun 2022 06:26:08 GMT) */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Bildr=t():(e.Bildr=e.Bildr||{},e.Bildr.marketplace=t())}(self,(()=>(()=>{"use strict";var e={d:(t,i)=>{for(var s in i)e.o(i,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:i[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{MarketplacePlugin:()=>n});class i{constructor(e,t){this.name=e,this._execFunc=t}execFunc(e){return this._execFunc(e)}}class s{constructor(){this._registeredPlugins=[]}register(e){if(null==e.name||null==e.name||0==e.name.trim().length)throw new Error("Name is required to register a plugin.");if(s.isRegistered(e.name))throw new Error(`Plugin with name '${e.name}' already registered. Name needs to be unique.`);this.startListeningForMessagesFromIFrame(),this._registeredPlugins.push(e),e.renderPage()}isRegistered(e){return null!=this._registeredPlugins.find((t=>t.name==e))}remove(e){let t=this._registeredPlugins.find((t=>t.name==e));null!=t&&(t.remove(),this._registeredPlugins.forEach(((e,i)=>{e===t&&this._registeredPlugins.splice(i,1)})))}get window(){return window}startListeningForMessagesFromIFrame(){0==this._registeredPlugins.length&&this.window.addEventListener("message",(e=>{this.triggerActionInPlugin(e)}))}triggerActionInPlugin(e){if(!e.data)return;let t=e.data,i=this._registeredPlugins.find((e=>t.pluginName&&e.name==t.pluginName));null!=i&&(null==t.data&&(t.data={}),t.data.uMsgId=t.uMsgId,i.triggerAction(t.command,t.data))}static getInstance(){return null==this._instance&&(this._instance=new s),this._instance}static remove(e){this.getInstance().remove(e)}static isRegistered(e){return this.getInstance().isRegistered(e)}static register(e){this.getInstance().register(e)}}class n extends class{constructor(e,t){this._actions=[],this._name=e,this._pageUrl=t,this._divId=Math.random().toString(16).slice(2),this._frameId=Math.random().toString(16).slice(2)}get name(){return this._name}get divElem(){return this._divElem}isSameDivElem(e){return this._divElem===e}sendOutgoingMessage(e,t){document.getElementById(this._frameId).contentWindow.postMessage({msgId:e,result:t},"*")}triggerAction(e,t){if(null==t.uMsgId||null==t.uMsgId||""==t.uMsgId)throw new Error("uMsgId should be set on argument actionData");let i=this._actions.find((t=>t.name==e));if(null==i)throw new Error(`Unknown action '${e}' on plugin '${this.name}'`);let s=i.execFunc(t);return s&&this.sendOutgoingMessage(t.uMsgId,s),s}hide(){this._divElem.style.right="-400px"}show(){this._divElem.style.width="400px",this._divElem.style.right="0px"}toggleVisibility(){this.isVisible?this.hide():this.show()}get isVisible(){return"0px"==this._divElem.style.right}get document(){return window.document}renderPage(){if(!this._divElem){let e=this.document.createElement("div");e.id=this._divId,e.style.cssText="width:0px;height:100vh;top:0px;left:unset;right:-400px;bottom:unset;border:none;background:#ffffff;position: fixed;z-index: 100010;overflow: hidden;position:absolute;transition: right 300ms ease-in-out 0s;",e.innerHTML=`<iframe id='${this._frameId}' src='${this._pageUrl}' style='all:unset;width:100%;height:100%'></iframe>`,this.document.body.appendChild(e),e.addEventListener("transitionend",(t=>{"0px"!=e.style.right&&(e.style.width="0px")})),this._divElem=e}}remove(){this.document.body.removeChild(this._divElem)}addActionObject(e){this.addAction(e.name,e.execFunc)}addAction(e,t){this._actions.push(new i(e,t))}}{constructor(){super("marketplace","https://marketplace.bildr.com/BE"),this.Version="2",this.addAction("hideMarketplacePlugin",(()=>{this.hide()})),this.addAction("getMarketPlaceVersion",(()=>this.Version)),this.addAction("getProjectActionTypes",(()=>d.getProjectActionTypes())),this.addAction("getProjectFunctions",(()=>d.getProjectFunctions())),this.addAction("getProjectPreviewId",(()=>d.getProjectPreviewId())),this.addActionObject(new r),this.addActionObject(new a(this.sendOutgoingMessage)),this.addActionObject(new o(this.sendOutgoingMessage)),this.addActionObject(new c(this.sendOutgoingMessage))}sendOutgoingMessage(e,t){var i={result:"succes",message:"",data:t};super.sendOutgoingMessage(e,i)}}class r{get name(){return"getActionTypeByMarketplaceId"}execFunc(e){return d.getProjectActionTypes().find((t=>{var i;return(null===(i=t.opts.marketplace)||void 0===i?void 0:i.actionTypeID)==e.actionTypeId}))}}class o{constructor(e){this._sendMessageFunc=e}get name(){return"updateActionTypeWithFunctions"}execFunc(e){for(var t=0;t<e.functions.length;t++){var i=e.functions[t];let n={last:t+1==e.functions.length};var s={id:i.id,opts:i.opts};d.saveFiltersetRecord("7",s,n,((t,i)=>{i.last&&d.saveFiltersetRecord("16",e.actionTypeJson,null,(t=>{this._sendMessageFunc(e.msgId,t)}))}))}}}class a{constructor(e){this._sendMessageFunc=e}get name(){return"getActionTypeByMarketplaceId"}execFunc(e){for(var t=e.functions.map((e=>({originalId:e.id,newId:"0",data:{id:0,type:e.type,name:e.name,opts:e.opts,JsCode:e.JsCode}}))),i=0;i<t.length;i++){var s=t[i];let n={index:i,last:i+1==t.length};d.saveFiltersetRecord("7",s.data,n,((i,s)=>{let n=s.index;if(t[n].newId=i.recs[0].id,s.last){t.forEach((t=>{for(let i=0;i<e.actionTypeJson.functions.length;i++)e.actionTypeJson.functions[i].id==t.originalId&&(e.actionTypeJson.functions[i].id=t.newId)}));var r={id:0,name:e.actionTypeJson.settings.displayName,opts:e.actionTypeJson};d.saveFiltersetRecord("16",r,null,(t=>{this._sendMessageFunc(e.msgId,t)}))}}))}}}class c{constructor(e){this._sendMessageFunc=e}get name(){return"imageUrlToBase64"}execFunc(e){this.imageUrlToBase64(e.iconUrl,(t=>{this._sendMessageFunc(e.msgId,t)}))}imageUrlToBase64(e,t){var i=new Image;i.crossOrigin="Anonymous",i.onload=function(){let e=i.naturalHeight,s=i.naturalHeight;e>s?e>30&&(s*=30/e,e=30):s>30&&(e*=30/s,s=30);let n=document.createElement("CANVAS"),r=n.getContext("2d");n.height=s,n.width=e,r.drawImage(i,0,0,e,s);let o=n.toDataURL("image/png");t(o)},i.src=e,(i.complete||void 0===i.complete)&&(i.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",i.src=e)}}class d{static saveFiltersetRecord(e,t,i,s){var n=new Action(0,0,0,"BildrAPIHelper adding filterset: "+t.filtersetID,"","");n.exec=function(n){var r=parseStrAsJson(t);RecordSave(r,e,n,(function(e,t){e.recs.forEach((i=>{i.ERROR&&1==i.ERROR&&(console.log("ERROR IN: BildrAPIHelper.saveFiltersetRecord.onSucces"),console.log("message: "+JSON.stringify(t)),console.log(e))})),QueueExecNextActions(n),s&&s(e,i)}),(function(e,t){console.log("ERROR IN: BildrAPIHelper.saveFiltersetRecord.onError"),console.log("message: "+JSON.stringify(t)),console.log(e),QueueExecNextActions(n)}),null,null)},d.addToActionQueue2(n)}static addToActionQueue2(e){var t=brwFormRoot.brObj,i=brwFormRoot;new QueueAction(e,1,null,t,{brwObj:t,brwForm:i,event:null},null,null,null,1)}static getProjectActionTypes(){return BildrDBCacheGet(!0).actionsTypes.recs.filter((e=>0==e.opts.archived&&(!e.opts.coreType||1*e.opts.coreType==0)))}static getProjectFunctions(){let e=BildrDBCacheGet(!0).functions.recs.filter((e=>!e.deleted||1*e.deleted==0));return e=e.map((e=>({id:e.id,JsCode:e.JsCode,modifiedDate:e.modifiedDate,name:e.name,opts:e.opts,type:e.type}))),e}static getProjectPreviewId(){return location.href.split("=")[1]}}class l{static isTopBarAvailable(){return document.querySelector(`.${l.topMenuBarDivCss}`)}static create(){if(!document.getElementById(l.marketplaceMenuItemDivId)){let i=new n;s.register(i);var e=document.querySelector(`.${l.topMenuBarDivCss}`);e.style.width="520px";var t=document.createElement("div");t.id=l.marketplaceMenuItemDivId,t.className="css_BRQAelSiDkOyetXlS0VDMQ",t.innerHTML="<img src='https://documents-weu.bildr.com/r9f576480f5ba4b118cec7ce8e6c345e3/doc/Bildr marketplace logo WB color.ynHqabhunkG6oesIc3Xzvg.png' class='css_0EWldTyzqU60XwJWKjRXog' style='filter:none;'><p class='css_BzJ7ABkWfkeHKsQbcZKVbA css_ixReGSYmjkKU0b6bxZNTHw'>market</p>",e.appendChild(t),document.body.addEventListener("click",(e=>{let t=new n;var s=e&&e.target;let r="hide";for(;s.parentNode;){if(i.isSameDivElem(s)){r="";break}if(s&&s.id==l.marketplaceMenuItemDivId){r="toggle";break}s=s.parentNode}"hide"==r&&t.hide(),"toggle"==r&&t.toggleVisibility()}),{capture:!0})}}}l.marketplaceMenuItemDivId="bildrMarketplaceMenuItem",l.topMenuBarDivCss="css_V9oRPFpIjEqGDrWGUv9yWg";var u=[];return u.push(new MutationObserver((function(e,t){l.isTopBarAvailable()&&(t.disconnect(),l.create())}))),-1!=location.href.indexOf("https://www.bildr.com/studio?projectName=")&&u.forEach((e=>{e.observe(document,{childList:!0,subtree:!0})})),t})()));
//# sourceMappingURL=bildr-marketplace.min.js.map